## 蚂蚁森林植物申领统计

问题：假设2017年1月1日开始记录低碳数据（user_low_carbon），假设2017年10月1日之前满足申领条件的用户都申领了一颗p004-胡杨，剩余的能量全部用来领取“p002-沙柳” 。
统计在10月1日累计申领“p002-沙柳” 排名前10的用户信息；以及他比后一名多领了几颗沙柳。
得到的统计结果如下表样式：

| user_id | plant_count | less_count(比后一名多领了几颗沙柳) |      |
| ------- | ----------- | ---------------------------------- | ---- |
| u_101   | 1000        | 100                                |      |
| u_088   | 900         | 400                                |      |
| u_103   | 500         | …                                  |      |

**解**

数据参考 

doc/蚂蚁金服题目和答案/plant_carbon.txt

doc/蚂蚁金服题目和答案/user_low_carbon.txt

```sql
# 建表
create table user_low_carbon
(
    user_id String
   ,data_dt String
   ,low_carbon int
) 
comment '用户低碳表'
row format delimited fields terminated by '\t';

create table plant_carbon
(
    plant_id string
   ,plant_name String
   ,low_carbon int
)
comment '植物低碳维表'
row format delimited fields terminated by '\t';

# 上传数据到HDFS
hdfs dfs -put user_low_carbon.txt /user/hivedb/user_low_carbon
hdfs dfs -put plant_carbon.txt /user/hivedb/plant_carbon
```

**sql实现**

```sql
select 
    user_id
   ,treeCount
   ,treeCount-(lead(treeCount,1) over(order by treeCount desc))
from 
(
    select 
        user_id
       ,floor((t1.sum_carbon-t2.low_carbon)/t3.low_carbon) treeCount 
    from
    (
        select 
            user_id
           ,sum(low_carbon) sum_carbon
        from user_low_carbon
        where datediff(regexp_replace(data_dt,"/","-"),"2017-10-1")<0
        group by user_id
        order by sum_carbon desc
        limit 11
    )t1,
    (select low_carbon from plant_carbon where plant_id="p004")t2,
    (select low_carbon from plant_carbon where plant_id="p002")t3
)t4
limit 10;
```

